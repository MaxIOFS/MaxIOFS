name: Nightly Build

on:
  schedule:
    - cron: '0 3 * * *' # Todos los dÃ­as a las 03:00 UTC
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  nightly:
    name: Nightly Build & Upload
    runs-on: ubuntu-latest
    environment: builds
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_S3_BUCKET_NAME: ${{ secrets.NIGHTLY_S3_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_PREFIX: nightly/${{ github.run_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Generate nightly version
        id: nightly_version
        run: |
          BASE_VERSION="0.7.0"
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          NIGHTLY_VERSION="${BASE_VERSION}-nightly-${COMMIT_SHORT}"
          echo "version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "Nightly version: ${NIGHTLY_VERSION}"

      - name: Download last built commit hash from S3
        id: get_last_commit
        run: |
          mkdir -p s3-latest
          aws s3 cp s3://${{ secrets.NIGHTLY_S3_BUCKET }}/nightly/latest/LAST_COMMIT s3-latest/LAST_COMMIT || echo "none" > s3-latest/LAST_COMMIT

      - name: Compare commit hashes and skip if no changes
        id: check_skip
        run: |
          CUR="${{ steps.nightly_version.outputs.commit_short }}"
          LAST=$(cat s3-latest/LAST_COMMIT 2>/dev/null | tr -d '[:space:]' || echo "none")
          echo "Current commit: '$CUR'"
          echo "Last built commit: '$LAST'"
          echo "Current length: ${#CUR}"
          echo "Last length: ${#LAST}"
          if [ "$CUR" = "$LAST" ]; then
            echo "âœ… Commits match. No new commits since last nightly. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ†• Commits differ. New commits detected. Proceeding with build."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop workflow if no new commits
        if: steps.check_skip.outputs.skip_build == 'true'
        run: |
          echo "No new commits. Exiting."
          exit 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Set up Python (for .deb packaging)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make upx zip dpkg fakeroot

      - name: Install Go dependencies
        run: |
          echo "Downloading Go dependencies from scratch (no cache)..."
          go mod download
          go mod verify

      - name: Install frontend dependencies
        run: |
          cd web/frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd web/frontend
          echo "Running frontend tests..."
          npm run test:run
          echo "âœ… All frontend tests passed"

      - name: Update frontend version
        run: |
          cd web/frontend
          npm version ${{ steps.nightly_version.outputs.version }} --no-git-tag-version
          echo "Frontend version updated to ${{ steps.nightly_version.outputs.version }}"

      - name: Build frontend
        run: |
          cd web/frontend
          npm run build

      - name: Run backend tests
        run: |
          echo "Running backend tests..."
          PKGS=$(go list ./... | grep -v '^github.com/maxiofs/maxiofs/web$')
          echo "Testing packages:" $PKGS
          go test $PKGS -v
          echo "âœ… All backend tests passed"

      - name: Build backend binaries
        run: |
          make clean
          VERSION=${{ steps.nightly_version.outputs.version }} make build-all

      - name: Build .deb packages
        run: |
          VERSION=${{ steps.nightly_version.outputs.version }} make deb
          VERSION=${{ steps.nightly_version.outputs.version }} make deb-arm64

      - name: Build RPM builder Docker image
        run: |
          echo "Building Docker image for RPM packaging..."
          docker build -f Dockerfile.rpm-builder -t maxiofs-rpm-builder .
          echo "Docker image built successfully"

      - name: Build .rpm packages
        run: |
          echo "Building RPM packages (AMD64 + ARM64) using Docker..."
          docker run --rm \
            -v $(pwd):/workspace \
            -e VERSION=${{ steps.nightly_version.outputs.version }} \
            maxiofs-rpm-builder
          echo "RPM packages built successfully"
          ls -lah build/*.rpm || echo "Warning: No RPM files found"

      - name: Prepare artifacts
        run: |
          mkdir -p nightly-artifacts
          rm -rf build/debian-package build/debian-package-arm64 build/rpm-build build/rpm-build-arm64 build/rpm-package build/rpm-package-arm64
          cp -r build/* nightly-artifacts/
          echo "Artifacts prepared with version ${{ steps.nightly_version.outputs.version }}"
          echo ""
          echo "ðŸ“¦ Binary packages:"
          ls -lah nightly-artifacts/*.deb 2>/dev/null || echo "  No .deb files found"
          ls -lah nightly-artifacts/*.rpm 2>/dev/null || echo "  No .rpm files found"
          echo ""
          echo "ðŸ—œï¸ Binary archives:"
          ls -lah nightly-artifacts/*.tar.gz nightly-artifacts/*.zip 2>/dev/null || echo "  No archives found"
          echo ""
          echo "ðŸ“ All artifacts:"
          ls -lah nightly-artifacts/

      - name: Save current commit hash
        run: |
          echo "${{ steps.nightly_version.outputs.commit_short }}" > nightly-artifacts/LAST_COMMIT

      - name: Upload to S3
        run: aws s3 sync ./nightly-artifacts s3://${{ secrets.NIGHTLY_S3_BUCKET }}/nightly/latest --delete

      - name: Build summary
        if: success()
        run: |
          echo "## âœ… Nightly Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.nightly_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.nightly_version.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "- Backend binaries (linux-amd64, linux-arm64, darwin-amd64, darwin-arm64, windows-amd64)" >> $GITHUB_STEP_SUMMARY
          echo "- Debian packages (.deb for amd64 and arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- RPM packages (.rpm for x86_64 and aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ S3 Location: \`s3://${{ secrets.NIGHTLY_S3_BUCKET }}/nightly/latest/\`" >> $GITHUB_STEP_SUMMARY

      - name: Build failure summary
        if: failure()
        run: |
          echo "## âŒ Nightly Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.nightly_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.nightly_version.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ The build failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend tests failed" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend tests failed" >> $GITHUB_STEP_SUMMARY
          echo "- Build compilation errors" >> $GITHUB_STEP_SUMMARY
          echo "- Package generation errors" >> $GITHUB_STEP_SUMMARY
