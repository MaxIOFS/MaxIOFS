name: Nightly Build

on:
  schedule:
    - cron: '0 3 * * *' # Todos los dÃ­as a las 03:00 UTC
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  nightly:
    name: Nightly Build & Upload
    runs-on: ubuntu-latest
    environment: builds
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_S3_BUCKET_NAME: ${{ secrets.NIGHTLY_S3_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_PREFIX: nightly/${{ github.run_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Generate nightly version
        id: nightly_version
        run: |
          BASE_VERSION="0.3.3"
          DATE=$(date +%Y%m%d)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          NIGHTLY_VERSION="${BASE_VERSION}-nightly-${DATE}-${COMMIT_SHORT}"
          echo "version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "Nightly version: ${NIGHTLY_VERSION}"

      - name: Download last built commit hash from S3
        id: get_last_commit
        run: |
          mkdir -p s3-latest
          aws s3 cp s3://${{ secrets.NIGHTLY_S3_BUCKET }}/nightly/latest/LAST_COMMIT s3-latest/LAST_COMMIT || echo "none" > s3-latest/LAST_COMMIT

      - name: Compare commit hashes and skip if no changes
        id: check_skip
        run: |
          CUR="${{ steps.nightly_version.outputs.commit_hash }}"
          LAST=$(cat s3-latest/LAST_COMMIT 2>/dev/null || echo "none")
          echo "Current commit: $CUR"
          echo "Last built commit: $LAST"
          if [ "$CUR" = "$LAST" ]; then
            echo "No new commits since last nightly. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "New commits detected. Proceeding with build."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop workflow if no new commits
        if: steps.check_skip.outputs.skip_build == 'true'
        run: |
          echo "No new commits. Exiting."
          exit 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Set up Python (for .deb packaging)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make upx zip dpkg fakeroot

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            web/frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('web/frontend/package-lock.json') }}


      - name: Update frontend version
        run: |
          cd web/frontend
          npm version ${{ steps.nightly_version.outputs.version }} --no-git-tag-version
          echo "Frontend version updated to ${{ steps.nightly_version.outputs.version }}"

      - name: Build frontend
        run: |
          cd web/frontend
          npm ci
          npm run build

      - name: Build backend binaries
        run: |
          make clean
          VERSION=${{ steps.nightly_version.outputs.version }} make build-all

      - name: Build .deb packages
        run: |
          VERSION=${{ steps.nightly_version.outputs.version }} make deb
          VERSION=${{ steps.nightly_version.outputs.version }} make deb-arm64

      - name: Prepare artifacts
        run: |
          mkdir -p nightly-artifacts
          rm -rf build/debian-package build/debian-package-arm64
          cp -r build/* nightly-artifacts/
          echo "Artifacts prepared with version ${{ steps.nightly_version.outputs.version }}"
          ls -lah nightly-artifacts/

      - name: Save current commit hash
        run: |
          echo "${{ steps.nightly_version.outputs.commit_hash }}" > nightly-artifacts/LAST_COMMIT

      - name: Upload to S3
        run: aws s3 sync ./nightly-artifacts s3://${{ secrets.NIGHTLY_S3_BUCKET }}/nightly/latest --delete
