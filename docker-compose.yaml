# MaxIOFS Docker Compose Configuration
# Version: 0.9.1-beta
#
# Usage:
#   docker compose up                    # Basic: MaxIOFS only
#   docker compose --profile monitoring up  # With Prometheus + Grafana
#   docker compose --profile cluster up     # Multi-node cluster setup
#
# Quick commands:
#   make docker-build       # Build image
#   make docker-up          # Start basic
#   make docker-monitoring  # Start with monitoring
#   make docker-down        # Stop all
#   make docker-logs        # View logs

services:
  # =============================================================================
  # MaxIOFS Main Service
  # =============================================================================
  maxiofs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-0.9.1-beta}
        COMMIT: ${GIT_COMMIT:-dev}
        BUILD_DATE: ${BUILD_DATE}
    image: maxiofs:${VERSION:-0.9.1-beta}
    container_name: maxiofs
    restart: unless-stopped

    ports:
      - "8080:8080"  # S3 API
      - "8081:8081"  # Web Console

    volumes:
      - maxiofs-data:/data
      # Optional: Mount custom config (create config.yaml first)
      # - ./config.yaml:/app/config.yaml:ro

    environment:
      # Server Configuration
      MAXIOFS_LISTEN: ":8080"
      MAXIOFS_CONSOLE_LISTEN: ":8081"
      MAXIOFS_DATA_DIR: "/data"
      MAXIOFS_LOG_LEVEL: "info"

      # Public URLs (adjust to your domain/IP)
      MAXIOFS_PUBLIC_API_URL: "http://localhost:8080"
      MAXIOFS_PUBLIC_CONSOLE_URL: "http://localhost:8081"

      # Security
      MAXIOFS_AUTH_ENABLE_AUTH: "true"
      MAXIOFS_AUTH_JWT_SECRET: "change-this-secret-key-in-production"

      # Metrics
      MAXIOFS_METRICS_ENABLE: "true"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

    networks:
      - maxiofs-network

    labels:
      - "com.maxiofs.version=0.9.1-beta"
      - "com.maxiofs.description=S3-compatible object storage server"

  # =============================================================================
  # Prometheus - Metrics Collection (monitoring profile)
  # =============================================================================
  prometheus:
    image: prom/prometheus:v3.0.1
    container_name: maxiofs-prometheus
    restart: unless-stopped
    profiles:
      - monitoring

    ports:
      - "9091:9090"

    volumes:
      - prometheus-data:/prometheus
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'

    networks:
      - maxiofs-network

    depends_on:
      maxiofs:
        condition: service_healthy

    labels:
      - "com.maxiofs.component=monitoring"

  # =============================================================================
  # Grafana - Visualization Dashboards (monitoring profile)
  # =============================================================================
  grafana:
    image: grafana/grafana:11.5.0
    container_name: maxiofs-grafana
    restart: unless-stopped
    profiles:
      - monitoring

    ports:
      - "3000:3000"

    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./docker/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro

    environment:
      # Security
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"

      # Server
      GF_SERVER_ROOT_URL: "http://localhost:3000"
      GF_SERVER_SERVE_FROM_SUB_PATH: "false"

      # Anonymous access (disable for production)
      GF_AUTH_ANONYMOUS_ENABLED: "false"

      # Dashboards
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/var/lib/grafana/dashboards/maxiofs.json"

    networks:
      - maxiofs-network

    depends_on:
      - prometheus

    labels:
      - "com.maxiofs.component=monitoring"

  # =============================================================================
  # MaxIOFS Cluster Nodes (cluster profile)
  # =============================================================================
  maxiofs-node2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-0.9.1-beta}
        COMMIT: ${GIT_COMMIT:-dev}
        BUILD_DATE: ${BUILD_DATE}
    image: maxiofs:${VERSION:-0.9.1-beta}
    container_name: maxiofs-node2
    restart: unless-stopped
    profiles:
      - cluster

    ports:
      - "8082:8080"  # S3 API
      - "8083:8081"  # Web Console

    volumes:
      - maxiofs-node2-data:/data

    environment:
      MAXIOFS_LISTEN: ":8080"
      MAXIOFS_CONSOLE_LISTEN: ":8081"
      MAXIOFS_DATA_DIR: "/data"
      MAXIOFS_LOG_LEVEL: "info"
      MAXIOFS_PUBLIC_API_URL: "http://localhost:8082"
      MAXIOFS_PUBLIC_CONSOLE_URL: "http://localhost:8083"
      MAXIOFS_AUTH_ENABLE_AUTH: "true"
      MAXIOFS_AUTH_JWT_SECRET: "change-this-secret-key-in-production"
      MAXIOFS_METRICS_ENABLE: "true"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

    networks:
      - maxiofs-network

    labels:
      - "com.maxiofs.version=0.9.1-beta"
      - "com.maxiofs.node=node2"

  maxiofs-node3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-0.9.1-beta}
        COMMIT: ${GIT_COMMIT:-dev}
        BUILD_DATE: ${BUILD_DATE}
    image: maxiofs:${VERSION:-0.9.1-beta}
    container_name: maxiofs-node3
    restart: unless-stopped
    profiles:
      - cluster

    ports:
      - "8084:8080"  # S3 API
      - "8085:8081"  # Web Console

    volumes:
      - maxiofs-node3-data:/data

    environment:
      MAXIOFS_LISTEN: ":8080"
      MAXIOFS_CONSOLE_LISTEN: ":8081"
      MAXIOFS_DATA_DIR: "/data"
      MAXIOFS_LOG_LEVEL: "info"
      MAXIOFS_PUBLIC_API_URL: "http://localhost:8084"
      MAXIOFS_PUBLIC_CONSOLE_URL: "http://localhost:8085"
      MAXIOFS_AUTH_ENABLE_AUTH: "true"
      MAXIOFS_AUTH_JWT_SECRET: "change-this-secret-key-in-production"
      MAXIOFS_METRICS_ENABLE: "true"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

    networks:
      - maxiofs-network

    labels:
      - "com.maxiofs.version=0.9.1-beta"
      - "com.maxiofs.node=node3"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  maxiofs-data:
    driver: local
    labels:
      - "com.maxiofs.volume=main"

  maxiofs-node2-data:
    driver: local
    labels:
      - "com.maxiofs.volume=node2"

  maxiofs-node3-data:
    driver: local
    labels:
      - "com.maxiofs.volume=node3"

  prometheus-data:
    driver: local
    labels:
      - "com.maxiofs.component=monitoring"

  grafana-data:
    driver: local
    labels:
      - "com.maxiofs.component=monitoring"

# =============================================================================
# Networks
# =============================================================================
networks:
  maxiofs-network:
    driver: bridge
    labels:
      - "com.maxiofs.network=main"
